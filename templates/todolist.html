<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <title>Minu Ülesannete Töölaud</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f8ff; /* Light blue background */
        }
        .content {
            margin-left: 22%; /* Adjusted for sidebar */
            padding: 20px;
        }
        .board {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .column {
            flex: 1;
            background-color: #e6e6fa; /* Lavender background */
            padding: 10px;
            border-radius: 8px;
            min-height: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .column h2 {
            text-align: center;
            color: #333;
            cursor: pointer; /* Indicate editability */
            background-color: transparent; /* Default background */
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s ease; /* Smooth transition */
        }
        .column h2:hover {
            background-color: #d3d3d3; /* Grey background on hover */
        }
        .column h2:focus {
            background-color: transparent; /* Revert to transparent when clicked */
        }
        .task-card {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 20%;
            background-color: #333; /* Dark sidebar */
            position: fixed;
            height: 100%;
            overflow: auto;
        }
        li a {
            display: block;
            color: white;
            padding: 10px 16px;
            text-decoration: none;
            font-size: 40px;
        }
        li a.active {
            background-color: #04AA6D;
            color: white;
        }
        li a:hover:not(.active) {
            background-color: #575757;
            color: white;
        }
        .add-task-form {
            margin-bottom: 20px;
        }
        .add-task-form input {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .add-task-form button {
            padding: 8px 12px;
            background-color: #04AA6D;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-task-form button:hover {
            background-color: #037a50;
        }
    </style>
</head>
<body>
    <ul>
        <li><a class="index" href="/">Koduleht</a></li>
        <li><a href="pomodoro">Taimer</a></li>
        <li><a href="todolist" class="active">To-do list</a></li>
        <li><a href="settings">Settings</a></li>
    </ul>
    <div class="content">
        <form class="add-task-form" onsubmit="addTask(event)">
            <input type="text" id="new-task" placeholder="Lisa uus ülesanne" required>
            <button type="submit">Lisa</button>
        </form>
        <div style="display: flex; justify-content: flex-end; align-items: center;">
            <button id="add-column-btn" style="margin-bottom: 10px; padding: 6px 14px; font-size: 18px; background: #e6e6fa; border: 1px solid #ccc; border-radius: 6px; cursor: pointer;">+ Lisa tulp</button>
        </div>
        <div class="board" id="board">
            <!-- Tulbad lisatakse siia dünaamiliselt -->
        </div>
    </div>
    <script>
        // Teemade definitsioonid
        const THEMES = {
            default: {
                bgColor: "#f0f8ff",
                sidebarColor: "#333333",
                accent: "#04AA6D",
                accentHover: "#037a50"
            },
            darkblue: {
                bgColor: "#eaf2fb",        // much lighter blue background
                sidebarColor: "#16213a",   // much darker sidebar
                accent: "#3fa7ff",
                accentHover: "#2677b7"
            },
            swedbank: {
                bgColor: "#fff7f0",
                sidebarColor: "#ff8000",
                accent: "#ffb347",
                accentHover: "#ff9900"
            }
        };

        function getTheme() {
            return localStorage.getItem("theme") || "default";
        }

        function applyTheme() {
            const theme = THEMES[getTheme()] || THEMES.default;
            document.body.style.backgroundColor = theme.bgColor;
            const sidebarEl = document.querySelector("ul");
            if (sidebarEl) sidebarEl.style.backgroundColor = theme.sidebarColor;

            // Lisa või uuenda dünaamiline stiil
            let styleTag = document.getElementById("sidebar-dynamic-style");
            if (!styleTag) {
                styleTag = document.createElement("style");
                styleTag.id = "sidebar-dynamic-style";
                document.head.appendChild(styleTag);
            }
            styleTag.textContent = `
                ul li a.active {
                    background-color: ${theme.accent} !important;
                    color: white !important;
                }
                ul li a:hover:not(.active) {
                    background-color: ${theme.accentHover} !important;
                    color: white !important;
                }
                .add-task-form button, #add-column-btn {
                    background-color: ${theme.accent} !important;
                }
                .add-task-form button:hover, #add-column-btn:hover {
                    background-color: ${theme.accentHover} !important;
                }
            `;
        }

        // Column management
        function getColumns() {
            // Proovi laadida localStoragest, kui pole, kasuta vaikimisi kolme tulpa
            const saved = localStorage.getItem("columns");
            if (saved) return JSON.parse(saved);
            return [
                { id: "todo", name: "Tegemata" },
                { id: "doing", name: "Tegemisel" },
                { id: "done", name: "Tehtud" }
            ];
        }
        function saveColumns(columns) {
            localStorage.setItem("columns", JSON.stringify(columns));
        }

        function renderColumns() {
            const board = document.getElementById("board");
            board.innerHTML = "";
            const columns = getColumns();
            columns.forEach(col => {
                const columnDiv = document.createElement("div");
                columnDiv.className = "column";
                columnDiv.id = col.id;
                columnDiv.ondrop = drop;
                columnDiv.ondragover = allowDrop;

                // Header with editable name and remove button
                const headerDiv = document.createElement("div");
                headerDiv.style.display = "flex";
                headerDiv.style.justifyContent = "space-between";
                headerDiv.style.alignItems = "center";

                const h2 = document.createElement("h2");
                h2.contentEditable = "true";
                h2.textContent = col.name;
                h2.onblur = function() {
                    saveColumnNames();
                };
                h2.style.flex = "1";
                h2.style.margin = "0";
                h2.style.paddingRight = "8px";

                // Remove button (hide if only one column left)
                const removeBtn = document.createElement("button");
                removeBtn.innerHTML = "&#10006;";
                removeBtn.title = "Eemalda tulp";
                removeBtn.style.background = "none";
                removeBtn.style.border = "none";
                removeBtn.style.color = "#888";
                removeBtn.style.fontSize = "22px";
                removeBtn.style.cursor = "pointer";
                removeBtn.style.marginLeft = "2px";
                removeBtn.onclick = function() {
                    removeColumn(col.id);
                };
                if (columns.length <= 1) removeBtn.style.display = "none";

                headerDiv.appendChild(h2);
                headerDiv.appendChild(removeBtn);

                columnDiv.appendChild(headerDiv);

                board.appendChild(columnDiv);
            });
            loadTasks();
            loadColumnNames();
        }

        function addColumn() {
            const columns = getColumns();
            // Genereeri unikaalne id
            let idx = 1;
            let newId;
            do {
                newId = "col" + idx++;
            } while (columns.some(c => c.id === newId));
            columns.push({ id: newId, name: "Uus tulp" });
            saveColumns(columns);
            saveColumnNames(); // et ka nimed oleksid sünkroonis
            saveTasks(); // et ka tasks struktuur oleks sünkroonis
            renderColumns();
        }

        function removeColumn(colId) {
            let columns = getColumns();
            if (columns.length <= 1) return; // Ära luba viimast eemaldada
            columns = columns.filter(c => c.id !== colId);
            saveColumns(columns);

            // Eemalda ka selle tulba ülesanded ja nimi
            const tasks = JSON.parse(localStorage.getItem("tasks") || "{}");
            delete tasks[colId];
            localStorage.setItem("tasks", JSON.stringify(tasks));

            const columnNames = JSON.parse(localStorage.getItem("columnNames") || "{}");
            delete columnNames[colId];
            localStorage.setItem("columnNames", JSON.stringify(columnNames));

            renderColumns();
        }

        document.getElementById("add-column-btn").onclick = addColumn;

        // Muudetud: tasks ja nimed arvestavad dünaamilisi tulpi
        function saveTasks() {
            const columns = getColumns();
            const tasks = {};
            columns.forEach(column => {
                const colDiv = document.getElementById(column.id);
                if (!colDiv) return;
                tasks[column.id] = [];
                colDiv.querySelectorAll(".task-card").forEach(task => {
                    tasks[column.id].push({ id: task.id, text: task.querySelector("span").textContent });
                });
            });
            localStorage.setItem("tasks", JSON.stringify(tasks));
        }

        function loadTasks() {
            const columns = getColumns();
            const tasks = JSON.parse(localStorage.getItem("tasks")) || {};
            columns.forEach(column => {
                const colDiv = document.getElementById(column.id);
                if (!colDiv) return;
                // Eemalda vanad taskid
                Array.from(colDiv.querySelectorAll(".task-card")).forEach(e => e.remove());
                (tasks[column.id] || []).forEach(task => {
                    const taskCard = document.createElement("div");
                    taskCard.id = task.id;
                    taskCard.className = "task-card";
                    taskCard.draggable = true;
                    taskCard.ondragstart = drag;

                    // Add task text
                    const taskTextElement = document.createElement("span");
                    taskTextElement.textContent = task.text;
                    taskCard.appendChild(taskTextElement);

                    // Add delete button
                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "✖";
                    deleteButton.style.cssText = "float: right; background: none; color: grey; border: none; font-size: 16px; cursor: pointer;";
                    deleteButton.onclick = () => {
                        taskCard.remove();
                        saveTasks();
                    };
                    taskCard.appendChild(deleteButton);

                    colDiv.appendChild(taskCard);
                });
            });
        }

        function saveColumnNames() {
            const columns = getColumns();
            const columnNames = {};
            columns.forEach(column => {
                const colDiv = document.getElementById(column.id);
                if (!colDiv) return;
                const h2 = colDiv.querySelector("h2");
                columnNames[column.id] = h2 ? h2.textContent.trim() : column.name;
            });
            localStorage.setItem("columnNames", JSON.stringify(columnNames));
        }

        function loadColumnNames() {
            const columns = getColumns();
            const columnNames = JSON.parse(localStorage.getItem("columnNames")) || {};
            columns.forEach(column => {
                const colDiv = document.getElementById(column.id);
                if (!colDiv) return;
                const h2 = colDiv.querySelector("h2");
                if (h2 && columnNames[column.id]) {
                    h2.textContent = columnNames[column.id];
                }
            });
        }

        // Muuda addTask, et lisaks alati esimesse tulpa
        function addTask(event) {
            event.preventDefault();
            const taskInput = document.getElementById("new-task");
            const taskText = taskInput.value.trim();
            if (taskText) {
                const taskId = `task-${Date.now()}`;
                const taskCard = document.createElement("div");
                taskCard.id = taskId;
                taskCard.className = "task-card";
                taskCard.draggable = true;
                taskCard.ondragstart = drag;

                // Add task text
                const taskTextElement = document.createElement("span");
                taskTextElement.textContent = taskText;
                taskCard.appendChild(taskTextElement);

                // Add delete button
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "✖";
                deleteButton.style.cssText = "float: right; background: none; color: grey; border: none; font-size: 16px; cursor: pointer;";
                deleteButton.onclick = () => {
                    taskCard.remove();
                    saveTasks();
                };
                taskCard.appendChild(deleteButton);

                // Lisa esimese tulpa
                const columns = getColumns();
                if (columns.length > 0) {
                    document.getElementById(columns[0].id).appendChild(taskCard);
                }
                taskInput.value = "";
                saveTasks();
            }
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            const taskId = ev.dataTransfer.getData("text");
            const taskElement = document.getElementById(taskId);
            const column = ev.target.closest(".column");

            // Determine the nearest spot in the column
            const tasks = Array.from(column.querySelectorAll(".task-card"));
            const dropY = ev.clientY;

            let inserted = false;
            for (let i = 0; i < tasks.length; i++) {
                const task = tasks[i];
                const taskRect = task.getBoundingClientRect();
                if (dropY < taskRect.top + taskRect.height / 2) {
                    column.insertBefore(taskElement, task);
                    inserted = true;
                    break;
                }
            }

            // If not inserted, append to the end
            if (!inserted) {
                column.appendChild(taskElement);
            }

            saveTasks();
        }

        document.addEventListener("DOMContentLoaded", () => {
            applyTheme();
            renderColumns();
        });
    </script>
</body>
</html>
