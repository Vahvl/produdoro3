<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <title>Minu Ülesannete Töölaud</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f8ff; /* Light blue background */
        }
        .content {
            margin-left: 22%; /* Adjusted for sidebar */
            padding: 20px;
        }
        .board {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .column {
            flex: 1;
            background-color: #e6e6fa; /* Lavender background */
            padding: 10px;
            border-radius: 8px;
            min-height: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .column h2 {
            text-align: center;
            color: #333;
            cursor: pointer; /* Indicate editability */
            background-color: transparent; /* Default background */
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s ease; /* Smooth transition */
        }
        .column h2:hover {
            background-color: #d3d3d3; /* Grey background on hover */
        }
        .column h2:focus {
            background-color: transparent; /* Revert to transparent when clicked */
        }
        .task-card {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            align-items: center;
        }
        .task-important {
            color: #e53935;
            font-weight: bold;
            margin-right: 8px;
            font-size: 20px;
        }
        .task-medium {
            color: #ff9800;
            font-weight: bold;
            margin-right: 8px;
            font-size: 20px;
        }
        .task-low {
            color: #1976d2;
            font-weight: bold;
            margin-right: 8px;
            font-size: 20px;
        }
        .task-menu-btn {
            background: none;
            border: none;
            font-size: 22px;
            color: #888;
            cursor: pointer;
            margin-left: auto;
            margin-right: 0;
            padding: 0 4px;
        }
        .task-menu-popup {
            display: none;
            position: absolute;
            right: 10px;
            top: 36px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 10;
            min-width: 220px;
            padding: 10px;
        }
        .task-card.show-menu .task-menu-popup {
            display: block;
        }
        .task-menu-popup label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .task-menu-popup input[type="text"], .task-menu-popup textarea {
            width: 100%;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            padding: 4px;
            font-size: 14px;
        }
        .task-menu-popup textarea {
            resize: vertical;
            min-height: 40px;
            max-height: 120px;
        }
        .task-menu-popup .task-menu-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        .task-menu-popup .importance-btn {
            background: #eee;
            border: 1px solid #bbb;
            border-radius: 4px;
            padding: 3px 8px;
            cursor: pointer;
            margin-right: 4px;
            font-size: 13px;
        }
        .task-menu-popup .importance-btn.selected {
            background: #04AA6D;
            color: #fff;
            border-color: #04AA6D;
        }
        .task-menu-popup .delete-btn {
            background: #e53935;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 3px 10px;
            cursor: pointer;
        }
        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 20%;
            background-color: #333; /* Dark sidebar */
            position: fixed;
            height: 100%;
            overflow: auto;
        }
        li a {
            display: block;
            color: white;
            padding: 10px 16px;
            text-decoration: none;
            font-size: 40px;
        }
        li a.active {
            background-color: #04AA6D;
            color: white;
        }
        li a:hover:not(.active) {
            background-color: #575757;
            color: white;
        }
        .add-task-form {
            margin-bottom: 20px;
        }
        .add-task-form input {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .add-task-form button {
            padding: 8px 12px;
            background-color: #04AA6D;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-task-form button:hover {
            background-color: #037a50;
        }
    </style>
</head>
<body>
    <ul>
        <li><a class="index" href="/">Koduleht</a></li>
        <li><a href="pomodoro">Taimer</a></li>
        <li><a href="todolist" class="active">To-do list</a></li>
        <li><a href="settings">Settings</a></li>
    </ul>
    <div class="content">
        <form class="add-task-form" onsubmit="addTask(event)">
            <input type="text" id="new-task" placeholder="Lisa uus ülesanne" required>
            <button type="submit">Lisa</button>
        </form>
        <div style="display: flex; justify-content: flex-end; align-items: center;">
            <button id="add-column-btn" style="margin-bottom: 10px; padding: 6px 14px; font-size: 18px; background: #e6e6fa; border: 1px solid #ccc; border-radius: 6px; cursor: pointer;">+ Lisa tulp</button>
        </div>
        <div class="board" id="board">
            <!-- Tulbad lisatakse siia dünaamiliselt -->
        </div>
    </div>
    <script>
        // Teemade definitsioonid
        const THEMES = {
            default: {
                bgColor: "#f0f8ff",
                sidebarColor: "#333333",
                accent: "#04AA6D",
                accentHover: "#037a50"
            },
            darkblue: {
                bgColor: "#eaf2fb",        // much lighter blue background
                sidebarColor: "#16213a",   // much darker sidebar
                accent: "#3fa7ff",
                accentHover: "#2677b7"
            },
            swedbank: {
                bgColor: "#fff7f0",
                sidebarColor: "#ff8000",
                accent: "#ffb347",
                accentHover: "#ff9900"
            }
        };

        function getTheme() {
            return localStorage.getItem("theme") || "default";
        }

        function applyTheme() {
            const theme = THEMES[getTheme()] || THEMES.default;
            document.body.style.backgroundColor = theme.bgColor;
            const sidebarEl = document.querySelector("ul");
            if (sidebarEl) sidebarEl.style.backgroundColor = theme.sidebarColor;

            // Lisa või uuenda dünaamiline stiil
            let styleTag = document.getElementById("sidebar-dynamic-style");
            if (!styleTag) {
                styleTag = document.createElement("style");
                styleTag.id = "sidebar-dynamic-style";
                document.head.appendChild(styleTag);
            }
            styleTag.textContent = `
                ul li a.active {
                    background-color: ${theme.accent} !important;
                    color: white !important;
                }
                ul li a:hover:not(.active) {
                    background-color: ${theme.accentHover} !important;
                    color: white !important;
                }
                .add-task-form button, #add-column-btn {
                    background-color: ${theme.accent} !important;
                }
                .add-task-form button:hover, #add-column-btn:hover {
                    background-color: ${theme.accentHover} !important;
                }
            `;
        }

        // Column management
        function getColumns() {
            // Proovi laadida localStoragest, kui pole, kasuta vaikimisi kolme tulpa
            const saved = localStorage.getItem("columns");
            if (saved) return JSON.parse(saved);
            return [
                { id: "todo", name: "Tegemata" },
                { id: "doing", name: "Tegemisel" },
                { id: "done", name: "Tehtud" }
            ];
        }
        function saveColumns(columns) {
            localStorage.setItem("columns", JSON.stringify(columns));
        }

        function renderColumns() {
            const board = document.getElementById("board");
            board.innerHTML = "";
            const columns = getColumns();
            columns.forEach(col => {
                const columnDiv = document.createElement("div");
                columnDiv.className = "column";
                columnDiv.id = col.id;
                columnDiv.ondrop = drop;
                columnDiv.ondragover = allowDrop;

                // Header with editable name and remove button
                const headerDiv = document.createElement("div");
                headerDiv.style.display = "flex";
                headerDiv.style.justifyContent = "space-between";
                headerDiv.style.alignItems = "center";

                const h2 = document.createElement("h2");
                h2.contentEditable = "true";
                h2.textContent = col.name;
                h2.onblur = function() {
                    saveColumnNames();
                };
                h2.style.flex = "1";
                h2.style.margin = "0";
                h2.style.paddingRight = "8px";

                // Remove button (hide if only one column left)
                const removeBtn = document.createElement("button");
                removeBtn.innerHTML = "&#10006;";
                removeBtn.title = "Eemalda tulp";
                removeBtn.style.background = "none";
                removeBtn.style.border = "none";
                removeBtn.style.color = "#888";
                removeBtn.style.fontSize = "22px";
                removeBtn.style.cursor = "pointer";
                removeBtn.style.marginLeft = "2px";
                removeBtn.onclick = function() {
                    removeColumn(col.id);
                };
                if (columns.length <= 1) removeBtn.style.display = "none";

                headerDiv.appendChild(h2);
                headerDiv.appendChild(removeBtn);

                columnDiv.appendChild(headerDiv);

                board.appendChild(columnDiv);
            });
            loadTasks();
            loadColumnNames();
        }

        function addColumn() {
            const columns = getColumns();
            // Genereeri unikaalne id
            let idx = 1;
            let newId;
            do {
                newId = "col" + idx++;
            } while (columns.some(c => c.id === newId));
            columns.push({ id: newId, name: "Uus tulp" });
            saveColumns(columns);
            saveColumnNames(); // et ka nimed oleksid sünkroonis
            saveTasks(); // et ka tasks struktuur oleks sünkroonis
            renderColumns();
        }

        function removeColumn(colId) {
            let columns = getColumns();
            if (columns.length <= 1) return; // Ära luba viimast eemaldada
            columns = columns.filter(c => c.id !== colId);
            saveColumns(columns);

            // Eemalda ka selle tulba ülesanded ja nimi
            const tasks = JSON.parse(localStorage.getItem("tasks") || "{}");
            delete tasks[colId];
            localStorage.setItem("tasks", JSON.stringify(tasks));

            const columnNames = JSON.parse(localStorage.getItem("columnNames") || "{}");
            delete columnNames[colId];
            localStorage.setItem("columnNames", JSON.stringify(columnNames));

            renderColumns();
        }

        document.getElementById("add-column-btn").onclick = addColumn;

        // Olulisuse klassid ja tekstid
        const IMPORTANCE = {
            none: { icon: "", class: "" },
            low: { icon: "!", class: "task-low", label: "Väheoluline" },
            medium: { icon: "!!", class: "task-medium", label: "Keskmine" },
            high: { icon: "!!!", class: "task-important", label: "Eriti oluline" }
        };

        // Muudetud: tasks salvestab ka description ja importance
        function saveTasks() {
            const columns = getColumns();
            const tasks = {};
            columns.forEach(column => {
                const colDiv = document.getElementById(column.id);
                if (!colDiv) return;
                tasks[column.id] = [];
                colDiv.querySelectorAll(".task-card").forEach(task => {
                    const text = task.querySelector(".task-text").textContent;
                    const desc = task.getAttribute("data-desc") || "";
                    const importance = task.getAttribute("data-importance") || "none";
                    tasks[column.id].push({
                        id: task.id,
                        text,
                        desc,
                        importance
                    });
                });
            });
            localStorage.setItem("tasks", JSON.stringify(tasks));
        }

        function loadTasks() {
            const columns = getColumns();
            const tasks = JSON.parse(localStorage.getItem("tasks")) || {};
            columns.forEach(column => {
                const colDiv = document.getElementById(column.id);
                if (!colDiv) return;
                // Eemalda vanad taskid
                Array.from(colDiv.querySelectorAll(".task-card")).forEach(e => e.remove());
                (tasks[column.id] || []).forEach(task => {
                    createTaskCard(colDiv, task);
                });
            });
        }

        function createTaskCard(parent, task) {
            const taskCard = document.createElement("div");
            taskCard.id = task.id;
            taskCard.className = "task-card";
            taskCard.draggable = true;
            taskCard.ondragstart = drag;
            taskCard.setAttribute("data-desc", task.desc || "");
            taskCard.setAttribute("data-importance", task.importance || "none");

            // Importance icon
            const imp = IMPORTANCE[task.importance || "none"];
            const impSpan = document.createElement("span");
            impSpan.className = imp.class || "";
            impSpan.textContent = imp.icon || "";
            impSpan.style.minWidth = "18px";
            taskCard.appendChild(impSpan);

            // Task text
            const taskTextElement = document.createElement("span");
            taskTextElement.className = "task-text";
            taskTextElement.textContent = task.text;
            taskCard.appendChild(taskTextElement);

            // Three dots menu button
            const menuBtn = document.createElement("button");
            menuBtn.className = "task-menu-btn";
            menuBtn.innerHTML = "&#8942;";
            menuBtn.onclick = function(e) {
                e.stopPropagation();
                // Hide all other menus
                document.querySelectorAll(".task-card.show-menu").forEach(card => {
                    if (card !== taskCard) card.classList.remove("show-menu");
                });
                taskCard.classList.toggle("show-menu");
            };
            taskCard.appendChild(menuBtn);

            // Popup menu
            const popup = document.createElement("div");
            popup.className = "task-menu-popup";
            popup.innerHTML = `
                <label>Ülesande nimi:
                    <input type="text" class="edit-task-name" value="${escapeHtml(task.text)}">
                </label>
                <label>Kirjeldus:
                    <textarea class="edit-task-desc" placeholder="Lisa kirjeldus...">${escapeHtml(task.desc || "")}</textarea>
                </label>
                <div class="task-menu-actions">
                    <div>
                        <button type="button" class="importance-btn" data-imp="none">Eemalda olulisus</button>
                        <button type="button" class="importance-btn" data-imp="low">Väheoluline</button>
                        <button type="button" class="importance-btn" data-imp="medium">Keskmine</button>
                        <button type="button" class="importance-btn" data-imp="high">Eriti oluline</button>
                    </div>
                    <button type="button" class="delete-btn">Kustuta</button>
                </div>
            `;
            taskCard.appendChild(popup);

            // Set selected importance
            Array.from(popup.querySelectorAll(".importance-btn")).forEach(btn => {
                if (btn.getAttribute("data-imp") === (task.importance || "none")) {
                    btn.classList.add("selected");
                }
                btn.onclick = function() {
                    taskCard.setAttribute("data-importance", btn.getAttribute("data-imp"));
                    // Update icon
                    const imp = IMPORTANCE[btn.getAttribute("data-imp")];
                    impSpan.className = imp.class || "";
                    impSpan.textContent = imp.icon || "";
                    // Highlight selected
                    popup.querySelectorAll(".importance-btn").forEach(b => b.classList.remove("selected"));
                    btn.classList.add("selected");
                    saveTasks();
                };
            });

            // Delete button
            popup.querySelector(".delete-btn").onclick = function() {
                taskCard.remove();
                saveTasks();
            };

            // Name and description change
            popup.querySelector(".edit-task-name").oninput = function() {
                taskTextElement.textContent = this.value;
                saveTasks();
            };
            popup.querySelector(".edit-task-desc").oninput = function() {
                taskCard.setAttribute("data-desc", this.value);
                saveTasks();
            };

            // Hide popup when clicking outside
            document.addEventListener("mousedown", function hideMenu(e) {
                if (!taskCard.contains(e.target)) {
                    taskCard.classList.remove("show-menu");
                }
            });

            parent.appendChild(taskCard);
        }

        // Escape HTML for safe input
        function escapeHtml(text) {
            return (text || "").replace(/[<>&"']/g, function(c) {
                return ({
                    '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'
                })[c];
            });
        }

        // Muuda addTask, et lisaks alati esimesse tulpa
        function addTask(event) {
            event.preventDefault();
            const taskInput = document.getElementById("new-task");
            const taskText = taskInput.value.trim();
            if (taskText) {
                const taskId = `task-${Date.now()}`;
                const task = {
                    id: taskId,
                    text: taskText,
                    desc: "",
                    importance: "none"
                };
                const columns = getColumns();
                if (columns.length > 0) {
                    createTaskCard(document.getElementById(columns[0].id), task);
                }
                taskInput.value = "";
                saveTasks();
            }
        }

        function saveColumnNames() {
            const columns = getColumns();
            const columnNames = {};
            columns.forEach(column => {
                const colDiv = document.getElementById(column.id);
                if (!colDiv) return;
                const h2 = colDiv.querySelector("h2");
                columnNames[column.id] = h2 ? h2.textContent.trim() : column.name;
            });
            localStorage.setItem("columnNames", JSON.stringify(columnNames));
        }

        function loadColumnNames() {
            const columns = getColumns();
            const columnNames = JSON.parse(localStorage.getItem("columnNames")) || {};
            columns.forEach(column => {
                const colDiv = document.getElementById(column.id);
                if (!colDiv) return;
                const h2 = colDiv.querySelector("h2");
                if (h2 && columnNames[column.id]) {
                    h2.textContent = columnNames[column.id];
                }
            });
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            const taskId = ev.dataTransfer.getData("text");
            const taskElement = document.getElementById(taskId);
            const column = ev.target.closest(".column");

            // Determine the nearest spot in the column
            const tasks = Array.from(column.querySelectorAll(".task-card"));
            const dropY = ev.clientY;

            let inserted = false;
            for (let i = 0; i < tasks.length; i++) {
                const task = tasks[i];
                const taskRect = task.getBoundingClientRect();
                if (dropY < taskRect.top + taskRect.height / 2) {
                    column.insertBefore(taskElement, task);
                    inserted = true;
                    break;
                }
            }

            // If not inserted, append to the end
            if (!inserted) {
                column.appendChild(taskElement);
            }

            saveTasks();
        }

        document.addEventListener("DOMContentLoaded", () => {
            applyTheme();
            renderColumns();
        });
    </script>
</body>
</html>
